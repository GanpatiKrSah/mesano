// src/main.js
import readline from "readline";
import {
  generateKeyPair,
  encapsulate,
  decapsulate,
  encryptMessage,
  decryptMessage,
} from "./algorithms/kyber.js";

function toHex(buf, limit = 64) {
  const str = Buffer.from(buf).toString("hex");
  return str.length > limit ? str.slice(0, limit) + "..." : str;
}

async function run() {
  console.log("\n=== CRYSTALS-KYBER Post-Quantum Message Encryption ===\n");

  // Input from terminal
  const rl = readline.createInterface({
    input: process.stdin,
    output: process.stdout,
  });

  const message = await new Promise((resolve) =>
    rl.question("Enter your message: ", (ans) => resolve(ans))
  );
  rl.close();

  console.log("\nGenerating Kyber key pair...");
  const { publicKey, secretKey } = await generateKeyPair();
  console.log("ğŸ”‘ Public Key:", toHex(publicKey));
  console.log("ğŸ—ï¸  Secret Key:", toHex(secretKey));

  console.log("\nEncapsulating (creating shared secret)...");
  const { ciphertext, sharedSecret } = await encapsulate(publicKey);
  console.log("ğŸ“¦ Ciphertext:", toHex(ciphertext));
  console.log("ğŸ¤ Shared Secret (derived):", toHex(sharedSecret, 128));

  console.log("\nEncrypting your message using shared secret...");
  const { iv, tag, encrypted } = encryptMessage(message, sharedSecret);
  console.log("ğŸ§© Encrypted Message:", toHex(encrypted, 128));
  console.log("IV:", toHex(iv));
  console.log("Auth Tag:", toHex(tag));

  console.log("\nDecrypting message using secret key...");
  const { sharedSecret: recvSecret } = await decapsulate(ciphertext, secretKey);
  const decrypted = decryptMessage(encrypted, iv, tag, recvSecret);
  console.log("ğŸ’¬ Decrypted Message:", decrypted);

  const match = message === decrypted;
  console.log("\nâœ… Match:", match ? "Yes (Perfect!)" : "No (Something's wrong)");
}

run().catch((err) => console.error("âŒ Error:", err));
